const e=z;performance.now();const t=e.z.object({歌名:e.z.string().optional(),歌手:e.z.string().optional(),封面:e.z.string().url({message:'封面URL格式无效'}).optional(),url:e.z.string().url({message:'音轨URL格式无效'})}).strict(),n=e.z.object({variable_path:e.z.string(),greater_than:e.z.number().optional(),greater_than_or_equal_to:e.z.number().optional(),less_than:e.z.number().optional(),less_than_or_equal_to:e.z.number().optional(),value:e.z.union([e.z.string(),e.z.number(),e.z.boolean()]).optional(),value_contains:e.z.string().optional(),time_in_range:e.z.string().regex(/^\d{2}:\d{2}-\d{2}:\d{2}$/,{message:'时间范围格式必须是 "HH:MM-HH:MM"'}).optional()}).strict(),a=e.z.object({type:e.z.literal('mvu_variable'),playlist_id:e.z.string(),priority:e.z.number().default(0),conditions:e.z.array(n).nonempty({message:'触发器必须至少包含一个条件'})}).strict(),i=e.z.object({id:e.z.string(),onFinishRule:e.z.enum(['loop','pop'],{message:'onFinishRule 必须是 \'loop\' 或 \'pop\''}).default('loop'),tracks:e.z.array(t).nonempty({message:'歌单的 \'tracks\' 列表不能为空'})}),r=e.z.object({default_playlist_id:e.z.string().optional(),playlists:e.z.array(i).optional(),triggers:e.z.array(a).optional(),is_mvu:e.z.boolean().optional()}).strict(),s=e.z.object({playlistId:e.z.string(),currentIndex:e.z.number().default(0),playedIndices:e.z.array(e.z.number()).default([]),wasEverPlayed:e.z.boolean().default(!1),triggerSource:a.optional()}),o=e.z.object({active_queue:e.z.array(s),mode:e.z.enum(['list','single','random']).default('list'),volume:e.z.number().min(0).max(1).default(.5),last_active_swipe_id:e.z.number().nullable().default(null),finished_base_playlists:e.z.array(e.z.string()).default([]),previousMvuState:e.z.record(e.z.string(),e.z.any()).optional()}),l='灰烬双星_MVU状态记忆';function c(e){if(!e||'string'!=typeof e)return null;const t=e.trim().replace('：',':');let n;if(n=t.match(/^(\d{1,2})\s*:\s*(\d{1,2})$/),n){const e=parseInt(n[1],10),t=parseInt(n[2],10);if(e>=0&&e<24&&t>=0&&t<60)return 60*e+t}if(n=t.match(/^(\d{1,2})\s*时\s*(\d{1,2})\s*分?$/),n){const e=parseInt(n[1],10),t=parseInt(n[2],10);if(e>=0&&e<24&&t>=0&&t<60)return 60*e+t}return null}const u=(()=>{let e={};function t(e,t){if(!t)return!1;for(const n of e.conditions){const e=_.get(t,n.variable_path);let a=!1,i=!1;if(void 0!==n.value_contains)i=!0,'string'==typeof e&&e.includes(n.value_contains)&&(a=!0);else if(void 0!==n.time_in_range){if(i=!0,'string'==typeof e){const t=c(e);if(null!==t){const[e,i]=n.time_in_range.split('-'),r=c(e),s=c(i);null!==r&&null!==s&&(a=r<=s?t>=r&&t<=s:t>=r||t<=s)}}}else void 0!==n.value?(i=!0,e===n.value&&(a=!0)):void 0!==n.greater_than?(i=!0,'number'==typeof e&&e>n.greater_than&&(a=!0)):void 0!==n.greater_than_or_equal_to?(i=!0,'number'==typeof e&&e>=n.greater_than_or_equal_to&&(a=!0)):void 0!==n.less_than?(i=!0,'number'==typeof e&&e<n.less_than&&(a=!0)):void 0!==n.less_than_or_equal_to&&(i=!0,'number'==typeof e&&e<=n.less_than_or_equal_to&&(a=!0));if(!i||!a)return!1}return!0}return{checkTriggerCondition:t,initialize(){try{const t=getVariables({type:'chat'})[l];e=t&&'object'==typeof t?t:{}}catch(t){e={}}},resetState(){e={}},async persistCurrentState(t){if(S){e=_.cloneDeep(t);try{await updateVariablesWith(t=>(t[l]=e,t),{type:'chat'})}catch(e){}}},getPreviousState:()=>_.cloneDeep(e),calculateChangeReport(e,n,a){const i={newlyActiveTriggers:[],newlyInactiveTriggers:[]};for(const r of a){const a=t(r,e),s=t(r,n);!a&&s?(r.playlist_id,i.newlyActiveTriggers.push(r)):a&&!s&&(r.playlist_id,i.newlyInactiveTriggers.push(r))}return i.newlyActiveTriggers.length,i.newlyInactiveTriggers.length,i}}})(),d=(()=>{const e=/<scene:\s*([^>]+)\s*>/g;return{getLatestState:async function(){try{const t=getChatMessages(-1);if(!t||0===t.length)return{'virtual.music_tag':null};const n=t[0].message_id,a=`${Math.max(0,n-19)}-${n}`,i=getChatMessages(a);for(let t=i.length-1;t>=0;t--){const n=i[t];if('user'===n.role)continue;const a=[...n.message.matchAll(e)];if(a.length>0){const e=a[a.length-1][1].trim();if('null'===e.toLowerCase())return n.message_id,{'virtual.music_tag':null};const t=e.toLowerCase();return n.message_id,{'virtual.music_tag':t}}return n.message_id,{'virtual.music_tag':null}}return{'virtual.music_tag':null}}catch(e){return{'virtual.music_tag':null}}}}})(),g=(()=>{let e=[],t=null,n=new Set,a='list',i=.5,r='STOPPED',s=!1;function o(e,t){'number'!=typeof t||t<0||e.playedIndices.add(t)}return{getPlaybackMode:()=>a,getVolume:()=>i,isPlaying:()=>'PLAYING'===r,getPlaybackState:()=>r,isPerformingEffect:()=>s,getTopQueueItem:()=>_.cloneDeep(e[0]),getQueue:()=>_.cloneDeep(e),getStateSnapshotForRuntime:()=>_.cloneDeep({active_queue:e,mode:a,volume:i,isPlaying:'PLAYING'===r,playbackState:r,isPerformingEffect:s}),getStateSnapshotForPersistence:()=>({active_queue:_.cloneDeep(e).map(e=>({..._.omit(e,['playbackPlan','planIndex','playlistContent']),playedIndices:Array.from(e.playedIndices)})),mode:a,volume:i,last_active_swipe_id:t,finished_base_playlists:Array.from(n)}),resetState(){e=[],a='list',i=.5,r='STOPPED',s=!1,t=null,n.clear()},loadState(r){a=r.mode,i=r.volume,e=r.active_queue||[],t=r.last_active_swipe_id??null,n=new Set(r.finished_base_playlists||[]),n.size,e.length},setPlaybackMode:e=>{a=e},setVolume:e=>{i=e},setPlaybackState:e=>{r=e},setPerformingEffect:e=>{s=e},getLastActiveSwipeId:()=>t,setLastActiveSwipeId:e=>{t=e},getFinishedBasePlaylists:()=>new Set(n),addToFinishedBasePlaylists:e=>{n.add(e)},clearFinishedBasePlaylists:()=>{n.clear()},updateQueue(t){t.length,e=_.cloneDeep(t).sort((e,t)=>t.priority-e.priority),e.length>0&&(e[0].playlistId,e[0].priority)},setCurrentIndex(t){const n=e[0];n&&(o(n,n.currentIndex),n.currentIndex=t)},commitNavigationStep(t){const n=e[0];if(n){if(o(n,n.currentIndex),'random'===a&&n.playbackPlan){const e=n.playbackPlan.indexOf(t);-1!==e&&(n.planIndex=e)}n.currentIndex=t}},clearHistoryForCurrentItem(){const t=e[0];t&&t.playedIndices.clear()},resetCurrentItemForLoop(){const t=e[0];t&&(t.playedIndices.clear(),t.currentIndex=0)},commitGenesisState(t,n,a){const i=e[0];i&&(i.currentIndex=t,i.playbackPlan=n,i.planIndex=a)},userInitiatedJump(t){const n=e[0];if(n&&t!==n.currentIndex&&(o(n,n.currentIndex),n.currentIndex=t,'random'===this.getPlaybackMode()&&n.playbackPlan)){const e=n.playbackPlan.indexOf(t);-1!==e&&(n.planIndex=e)}},clearRandomModePlan(){const t=e[0];t&&(t.playbackPlan=void 0,t.planIndex=void 0)},applyNewPlaybackPlan(t,n){const a=e[0];a&&(a.playbackPlan=t,a.planIndex=n)}}})(),y=(()=>{let e=null,t=null,n=null,a=null,i=null;function r(e,t,n){return new Promise(a=>{if(i&&(clearInterval(i),i=null),!e)return a();const r=e.volume,s=n/50;if(s<=0)return e.volume=t,a();const o=(t-r)/s;let l=0;i=window.setInterval(()=>{l++,l>=s?(i&&clearInterval(i),i=null,e.volume=t,a()):e.volume+=o},50)})}return{initialize(){if(e&&t)return;const i=()=>{const e=new Audio;return e.preload='auto',e.crossOrigin='anonymous',e.addEventListener('ended',()=>{e===n&&async function(){if(g.isPerformingEffect())return;const e=g.getTopQueueItem();if(!e)return;try{g.setPerformingEffect(!0),Q();const t=h.getCurrentStrategy().onTrackEnd(e),n=await W(t);n.needsAsyncEffect&&'number'==typeof n.targetIndex&&await H(n.targetIndex)}catch(e){await Y()}finally{await J(),await L('trackEnded')}}()}),e.addEventListener('error',()=>{}),e.addEventListener('timeupdate',O),e};e=i(),t=i(),n=e,a=t},getActivePlayer:()=>n,getStandbyPlayer:()=>a,async transitionToTrack(e,t){if(e.slice(0,50),!a||!n)throw new Error('播放器实例尚未初始化');const i=a,s=n;i.src=e,i.load();try{await new Promise((e,t)=>{const n=()=>{i.removeEventListener('canplaythrough',n),i.removeEventListener('error',a),e()},a=e=>{i.removeEventListener('canplaythrough',n),i.removeEventListener('error',a);const r=e.target.error;t(new Error(`音频加载失败: ${r?.message||'未知错误'}`))};i.addEventListener('canplaythrough',n),i.addEventListener('error',a)})}catch(e){throw e}await r(s,0,500),s.pause(),[n,a]=[a,n];const o=this.getActivePlayer();if(!o)throw new Error('播放器实例在交换后丢失');const l=o.play();l&&await l,await r(o,t,500)},async fadeOutAndPause(){await r(n,0,400),n?.pause()},async executeHardCut(e,t){e.slice(0,50);const n=this.getActivePlayer();if(!n)throw new Error('No active player available for hard cut.');n.src.slice(-50),n.pause(),n.src=e,n.volume=t,n.src.slice(-50);try{const e=n.play();e&&await e,g.setPlaybackState('PLAYING')}catch(e){throw g.setPlaybackState('STOPPED'),e}},async resumeAndFadeIn(e){const t=n?.play();t&&await t,await r(n,e,400)}}})();class p{onQueueChanged(e){}advance(e,t){if(e.playlistId,e.currentIndex,e.onFinishRule,'next'===t)return this.onTrackEnd(e);const{currentIndex:n,onFinishRule:a,playlistContent:i}=e,r=i.length;if(n>0){const e=n-1;return{action:'GoTo',nextIndex:e}}if('loop'===a){const e=r>0?r-1:0;return{action:'GoTo',nextIndex:e}}return{action:'Restart'}}onTrackEnd(e){e.playlistId,e.currentIndex,e.onFinishRule;const{currentIndex:t,onFinishRule:n,playlistContent:a,playedIndices:i}=e,r=t+1;if(r<a.length)return{action:'GoTo',nextIndex:r};if('pop'===n)return{action:'RemoveTopAndAdvance'};{const e=a.length;return i.size+1>=e?{action:'LoopReset'}:{action:'GoTo',nextIndex:0}}}onPlaybackError(e){return this.advance(e,'next')}}class f{onQueueChanged(e){}advance(e,t){return{action:'Restart'}}onTrackEnd(e){return{action:'Restart'}}onPlaybackError(e){return{action:'Stop'}}}class m{_generateIntelligentShuffle(e,t,n){e.length,t.size;const a=e.filter(e=>!t.has(e)&&e!==n);a.length;for(let e=a.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[a[e],a[t]]=[a[t],a[e]]}return a.join(', '),a}_generatePlaybackPlan(e,t,n){e.size,n.length;const a=Array.from(new Set([...e,t])),i=a.indexOf(t),r=[...a,...n];return a.join(', '),r.join(', '),{playbackPlan:r,planIndex:i}}_handlePlanEnd(e){return e.playlistId,e.onFinishRule,'pop'===e.onFinishRule?{action:'RemoveTopAndAdvance'}:{action:'LoopReset'}}onQueueChanged(e){if(!e)return;e.playlistId;const t=e.playlistContent.map((_,e)=>e),n=this._generateIntelligentShuffle(t,e.playedIndices,e.currentIndex),{playbackPlan:a,planIndex:i}=this._generatePlaybackPlan(e.playedIndices,e.currentIndex,n);g.applyNewPlaybackPlan(a,i)}prepareGenesis(e){if(!e||!e.playlistContent)return null;const t=e.playlistContent.map((_,e)=>e);for(let e=t.length-1;e>0;e--){const n=Math.floor(Math.random()*(e+1));[t[e],t[n]]=[t[n],t[e]]}const n=t,a=n[0];return{newCurrentIndex:a,newPlaybackPlan:n,newPlanIndex:0}}advance(e,t){const{playbackPlan:n,planIndex:a}=e;if(!n||void 0===a)return{action:'DoNothing'};if(n.join(', '),'next'===t){const t=a+1;if(t<n.length){const e=n[t];return{action:'GoTo',nextIndex:e}}return this._handlePlanEnd(e)}{const e=a-1;if(e>=0){const t=n[e];return{action:'GoTo',nextIndex:t}}return{action:'DoNothing'}}}onTrackEnd(e){const{playbackPlan:t,planIndex:n}=e;if(!t||void 0===n)return{action:'Stop'};t.join(', ');const a=n+1;if(a<t.length){const e=t[a];return{action:'GoTo',nextIndex:e}}return this._handlePlanEnd(e)}onPlaybackError(e){return this.advance(e,'next')}}const h=(()=>{const e={list:new p,single:new f,random:new m};let t=e.list;return{setMode(n){t=e[n]},getCurrentStrategy:()=>t,notifyQueueChanged(){t.constructor.name;const e=g.getTopQueueItem();t.onQueueChanged(e)}}})(),I='余烬双星_播放器状态';let v=!1,P=!1,w=null,b=null,S=!0,E={},x=[],T='',k=!1,C=!1,A=!0,M=null;const D=[],F=[];async function R(e,t){if(S&&!P){P=!0;try{g.setPerformingEffect(!0),Q();try{const n=g.getTopQueueItem();let a={};if(A)if(e?.stat_data)a=e.stat_data;else{const e=await j();a=e?e.mvuData?.stat_data??{}:{}}else a=await d.getLatestState();const i=u.getPreviousState(),r=u.calculateChangeReport(i,a,x),s=g.getQueue();if(r.newlyInactiveTriggers.length>0&&(_.remove(s,e=>r.newlyInactiveTriggers.some(t=>B(e.triggerSource,t))),r.newlyInactiveTriggers.length),r.newlyActiveTriggers.length>0)for(const e of r.newlyActiveTriggers){if(s.some(t=>t.triggerSource&&B(t.triggerSource,e))){e.playlist_id;continue}const t=q({type:'mvu',playlistId:e.playlist_id,trigger:e});t&&(s.push(t),t.playlistId)}g.updateQueue(s);const o=g.getTopQueueItem();if(o?.playlistId!==n?.playlistId)if(o){h.notifyQueueChanged(),o.wasEverPlayed=!0;const e=o.wasEverPlayed?o.currentIndex:0;if(g.isPlaying())'hard'===t?.transitionEffect?await y.executeHardCut(o.playlistContent[e].url,g.getVolume()):await H(e);else if(void 0===n&&'STOPPED'===g.getPlaybackState())await X(e);else{const t=o.playlistContent[e],n=y.getActivePlayer();t&&n&&(n.src=t.url)}}else await y.fadeOutAndPause(),g.setPlaybackState('STOPPED'),h.notifyQueueChanged();await u.persistCurrentState(a)}catch(e){}finally{await L('reconciliation')}}finally{P=!1,await J()}}}function Q(){const e=g.getTopQueueItem(),t=e?.playlistContent??[],n=e?.currentIndex??0,a={currentItem:t[n]?{title:t[n].歌名,artist:t[n].歌手,cover:t[n].封面}:null,isPlaying:g.isPlaying(),playbackState:g.getPlaybackState(),playbackMode:g.getPlaybackMode(),masterVolume:g.getVolume(),playlist:t.map(e=>({title:e.歌名,artist:e.歌手,cover:e.封面})),isTransitioning:g.isPerformingEffect()};D.forEach(e=>{try{e(a)}catch(e){}})}function O(){const e=y.getActivePlayer();if(!g.isPlaying()||!e)return;const t={currentTime:e.currentTime,duration:e.duration||0};F.forEach(e=>e(t))}async function L(e){if(S)try{const e=g.getStateSnapshotForPersistence();await updateVariablesWith(t=>(t[I]=e,t),{type:'chat'})}catch(e){}}function G(e){const t=e.issues[0],n=t.path.join(' -> '),a=t.message,i=`路径: ${n} | 问题: ${a}`;toastr.error(i,'[MusicConfig] 内容错误',{timeOut:15e3})}function B(e,t){if(!e||!t)return e===t;if(e.playlist_id!==t.playlist_id)return!1;const n=e=>Object.keys(e).sort().map(t=>`${t}:${String(e[t])}`).join(','),a=e.conditions.map(n).sort(),i=t.conditions.map(n).sort();return a.length===i.length&&a.every((e,t)=>e===i[t])}async function j(e){if(e&&0===e.messageId&&'number'==typeof e.swipeId){e.messageId,e.swipeId;try{const t=await Mvu.getMvuData({type:'message',message_id:0}),n=t?.swipes_data?.[e.swipeId];if(n?.stat_data)return{mvuData:n,messageId:0};if(t?.stat_data)return{mvuData:t,messageId:0}}catch(e){}}try{const e=getChatMessages(-1,{include_swipes:!0});for(let t=e.length-1;t>=0;t--){const n=e[t].message_id;if('number'==typeof n)try{const e=await Mvu.getMvuData({type:'message',message_id:n});if(e?.stat_data)return{mvuData:e,messageId:n}}catch(e){}}return null}catch(e){return null}}async function N(){class e extends Error{constructor(e){super(e),this.name='ConfigMissingError'}}const t={playlists:[],triggers:[],defaultPlaylistId:void 0,_defaultPlaylistIdSourceFile:null,explicitMvuMode:void 0};try{const n=getCharWorldbookNames('current'),a=[n.primary,...n.additional].filter(Boolean);if(0===a.length)throw new e('角色卡未关联任何世界书。');let i=!1;for(const e of a){if(!e)continue;const n=(await getWorldbook(e)).filter(e=>e.name.includes('[MusicConfig]'));n.length>0&&(i=!0);for(const e of n){e.name;try{const n=YAML.parse(e.content),a=r.safeParse(n);if(!a.success){e.name,G(a.error);continue}const i=a.data;if(i.playlists&&t.playlists.push(...i.playlists.map(t=>({...t,_sourceFile:e.name}))),i.triggers&&t.triggers.push(...i.triggers.map(t=>({...t,_sourceFile:e.name}))),i.default_playlist_id){if(t.defaultPlaylistId&&t.defaultPlaylistId!==i.default_playlist_id){const n=`在文件 "${e.name}" 中发现的 default_playlist_id ("${i.default_playlist_id}") 覆盖了来自文件 "${t._defaultPlaylistIdSourceFile??'未知'}" 的定义 ("${t.defaultPlaylistId}")。为确保行为可预测，建议只保留一个定义。`;toastr.warning(n,'配置警告',{timeOut:2e4,closeButton:!0})}t.defaultPlaylistId=i.default_playlist_id,t._defaultPlaylistIdSourceFile=e.name}void 0!==i.is_mvu&&(t.explicitMvuMode=i.is_mvu,e.name,i.is_mvu)}catch(t){e.name,t.message,toastr.error(`[MusicConfig] 文件 "${e.name}" 格式错误：YAML 语法不正确。`,'配置错误',{timeOut:1e4})}}}if(!i)throw new e('在已关联的世界书中，未找到任何包含 [MusicConfig] 的条目。');let s=!1;if(s=void 0!==t.explicitMvuMode?t.explicitMvuMode:t.triggers.length>0,!s){const e=new Set(t.playlists.map(e=>e.id));e.size;for(const n of e){const e={type:'mvu_variable',playlist_id:n,priority:0,conditions:[{variable_path:'virtual.music_tag',value:n.toLowerCase()}],_sourceFile:'System_Auto_Generated'};t.triggers.push(e)}Array.from(e)[0]}let o=!0;const l=_.groupBy(t.playlists,'id');for(const e in l)if(l[e].length>1){const t=`[MusicConfig] 致命错误: 歌单 ID "${e}" 在多个文件中重复定义。来源: ${l[e].map(e=>e._sourceFile).join(', ')}。ID 必须是唯一的。`;toastr.error(t,'配置冲突',{timeOut:15e3}),o=!1}const c=new Set(t.playlists.map(e=>e.id));if(t.defaultPlaylistId&&!c.has(t.defaultPlaylistId)){const e=`[MusicConfig] 配置错误: 最终的 default_playlist_id ("${t.defaultPlaylistId}", 来自文件 "${t._defaultPlaylistIdSourceFile??'未知'}") 指向了一个不存在的歌单。`;toastr.error(e,'配置错误',{timeOut:15e3}),t.defaultPlaylistId=void 0}const u=t.triggers.filter(e=>{if(c.has(e.playlist_id))return!0;const t=`[MusicConfig] 校验失败: 来自文件 "${e._sourceFile}" 的触发器指向了不存在的歌单ID "${e.playlist_id}"。该触发器将被忽略。`;return toastr.error(t,'配置错误',{timeOut:1e4}),!1});if(!o)return null;if(0===t.playlists.length)throw new e('所有配置文件中都未能找到任何有效的歌单 (playlists)。');const d={};for(const e of t.playlists){const t=e.tracks.map(e=>({url:e.url,歌名:e.歌名&&''!==e.歌名.trim()?e.歌名:decodeURIComponent(e.url.split('/').pop()?.split('?')[0]||'未知歌曲'),歌手:e.歌手,封面:e.封面}));d[e.id]={..._.omit(e,'_sourceFile'),tracks:t}}return{playlists:d,defaultId:t.defaultPlaylistId,triggers:u.map(e=>_.omit(e,'_sourceFile')),isMvu:s}}catch(t){return t instanceof e?(t.message,toastr.error(t.message,'[音乐播放器] 配置缺失',{timeOut:2e4,closeButton:!0})):toastr.error('播放器在加载设置时遇到一个临时问题。这通常可以通过按 F5 刷新酒馆页面来解决。','[音乐播放器] 加载时遇到临时问题',{timeOut:2e4,closeButton:!0}),null}}function V(e,t){return{playlistId:e.playlistId,priority:e.triggerSource?.priority??-1/0,playlistContent:_.cloneDeep(t.tracks),onFinishRule:t.onFinishRule,currentIndex:e.currentIndex,playedIndices:new Set(e.playedIndices),wasEverPlayed:e.wasEverPlayed,triggeredBy:e.triggerSource?'mvu':'base',triggerSource:e.triggerSource}}function q(e){const{playlistId:t}=e;if(!t||!E[t])return null;const n=E[t],a={playlistId:t,playlistContent:_.cloneDeep(n.tracks),currentIndex:0,playedIndices:new Set,wasEverPlayed:!1};return'base'===e.type?{...a,priority:-1/0,triggeredBy:'base',onFinishRule:n.onFinishRule??'loop'}:{...a,priority:e.trigger.priority,triggeredBy:'mvu',onFinishRule:n.onFinishRule,triggerSource:e.trigger}}async function U(e,t,n){try{C=!0;const a=function(){const e=getVariables({type:'chat'})[I];if(!e||'object'!=typeof e)return null;const t=o.safeParse(e);return t.success?t.data:null}();g.resetState(),a&&g.loadState(a),u.resetState(),u.initialize();const i=y.getActivePlayer();if(i&&i.pause(),x=[],E={},T='',!e)throw Q(),new Error('世界书音乐配置解析失败，请检查配置。');E=e.playlists,T=e.defaultId,x=e.triggers,A=e.isMvu;const r=t?.mvuData?.stat_data??null,s=t?.messageId;let l=[],c=T;const d=getChatMessages(0,{include_swipes:!0})[0],p=d?.swipe_id??0;if(d){const e=d.swipes?.[d.swipe_id],t=e?.match(/<playlist:([^>]+)>/);if(t&&t[1]){const e=t[1];if(E[e])c=e;else{const t=`[MusicConfig] 配置警告: 开场白标签 <playlist:${e}> 指向了一个不存在的歌单ID。将回退至默认歌单。`;toastr.warning(t,'配置警告',{timeOut:15e3})}}}const f=g.getLastActiveSwipeId();if(null!==f&&f!==p&&g.clearFinishedBasePlaylists(),g.setLastActiveSwipeId(p),e.isMvu&&c){if(new Set(x.map(e=>e.playlist_id)).has(c)){const e=`[MusicConfig] 致命配置错误: 歌单 "${c}" 不能同时被用作基础歌单（在开场白或默认设置中）和场景歌单（被触发器关联）。请为它们使用不同的歌单。`;throw toastr.error(e,'配置冲突',{timeOut:2e4,closeButton:!0}),new Error('基础歌单与场景歌单存在致命冲突。')}}else e.isMvu;if(a){const e=[];for(const t of a.active_queue){if(!Object.prototype.hasOwnProperty.call(E,t.playlistId)){t.playlistId;continue}const n=E[t.playlistId];if(!t.triggerSource)t.playlistId===c?(t.playlistId,e.push(V(t,n))):t.playlistId;else{const a=x.find(e=>e.playlist_id===t.playlistId);if(t.playlistId,'pop'===n.onFinishRule)continue;if(!a)continue;if(!u.checkTriggerCondition(a,r))continue;e.push(V(t,n))}}l=e}if(r&&x.length>0)for(const e of x){if(!l.some(t=>t.triggerSource&&B(t.triggerSource,e))&&u.checkTriggerCondition(e,r)){const t=E[e.playlist_id];if(t&&'pop'===t.onFinishRule)if(0===s){e.playlist_id;const t=q({type:'mvu',playlistId:e.playlist_id,trigger:e});t&&l.push(t)}else e.playlist_id;else{const t=q({type:'mvu',playlistId:e.playlist_id,trigger:e});t&&l.push(t)}}}if(!l.some(e=>'base'===e.triggeredBy)&&c&&E[c]){if(g.getFinishedBasePlaylists().has(c));else{const e=q({type:'base',playlistId:c});e&&l.push(e)}}g.updateQueue(l);const m=g.getPlaybackMode();h.setMode(m),h.notifyQueueChanged(),y.initialize();const v=g.getVolume();y.getActivePlayer()&&(y.getActivePlayer().volume=v),y.getStandbyPlayer()&&(y.getStandbyPlayer().volume=0);const P=g.getTopQueueItem();if(P){const e=P.playlistContent[P.currentIndex];e&&y.getActivePlayer()&&(y.getActivePlayer().src=e.url)}if(r?await u.persistCurrentState(r):await u.persistCurrentState({}),await L(),Q(),n?.autoPlayIfWasPlaying){g.getTopQueueItem()&&await async function(){if(g.isPerformingEffect())return;const e=g.getTopQueueItem();if(!e)return;try{g.setPerformingEffect(!0),e.currentIndex,await X(e.currentIndex)}catch(e){g.setPlaybackState('STOPPED'),Q()}finally{await J(),await L()}}()}}catch(e){throw e}}async function H(e){const t=g.getTopQueueItem();if(!t)return Promise.resolve();const n=t.playlistContent[e];if(!n?.url)throw new Error(`Invalid track at index ${e}`);try{await y.transitionToTrack(n.url,g.getVolume()),g.setPlaybackState('PLAYING'),function(){const e=g.getTopQueueItem(),t=y.getStandbyPlayer();if(!t||!e)return;const n=e.currentIndex+1;if(n<e.playlistContent.length){const a=e.playlistContent[n];a&&t.src!==a.url&&(t.src=a.url,t.load())}}()}catch(e){throw e}}async function Y(){let e=1;const t=g.getTopQueueItem(),n=t?.playlistContent.length??0;for(t&&toastr.error(`歌曲《${t.playlistContent[t.currentIndex]?.歌名??'未知歌曲'}》加载失败，正在尝试自动处理...`);;){if(n>0&&e>=n)return t&&toastr.error(`歌单《${t.playlistId}》中所有歌曲均无法加载，播放已停止。`),g.setPlaybackState('STOPPED'),void Q();const a=g.getTopQueueItem();if(!a)return g.setPlaybackState('STOPPED'),void Q();const i=h.getCurrentStrategy().onPlaybackError(a);h.getCurrentStrategy().constructor.name,i.action;const r=await W(i);if(!r.needsAsyncEffect)return;if('number'!=typeof r.targetIndex)return g.setPlaybackState('STOPPED'),void Q();try{return await H(r.targetIndex),void Q()}catch(t){e++;const n=g.getTopQueueItem(),a=n?.playlistContent[n.currentIndex]?.歌名??'未知歌曲';toastr.error(`下一首《${a}》加载失败...`)}}}async function W(e){e.action,e.nextIndex;let t,n=!1;const a=g.getTopQueueItem();switch(e.action){case'GoTo':'number'==typeof e.nextIndex?(g.commitNavigationStep(e.nextIndex),n=!0,t=e.nextIndex):n=!1;break;case'Restart':a&&(n=!0,t=a.currentIndex);break;case'RemoveTopAndAdvance':{const e=g.getTopQueueItem();e&&'base'===e.triggeredBy&&'pop'===e.onFinishRule&&(e.playlistId,g.addToFinishedBasePlaylists(e.playlistId));const a=g.getQueue();a.shift();g.updateQueue(a),h.notifyQueueChanged();const i=g.getTopQueueItem();i?(i.playlistId,i.currentIndex,n=!0,t=i.currentIndex):(await y.fadeOutAndPause(),g.setPlaybackState('STOPPED'),n=!1);break}case'LoopReset':{g.resetCurrentItemForLoop();if('random'===g.getPlaybackMode()){const e=h.getCurrentStrategy().prepareGenesis(g.getTopQueueItem());e&&g.commitGenesisState(e.newCurrentIndex,e.newPlaybackPlan,e.newPlanIndex)}const e=g.getTopQueueItem()?.currentIndex??0;n=!0,t=e;break}case'Stop':g.setPlaybackState('STOPPED')}'RemoveTopAndAdvance'!==e.action&&Q();const i={needsAsyncEffect:n,targetIndex:t};return i}async function J(){g.setPerformingEffect(!1),Q()}async function K(e){if(g.isPerformingEffect())return;const t=g.getTopQueueItem();if(t)try{g.setPerformingEffect(!0),Q();const n=h.getCurrentStrategy().advance(t,e),a=await W(n);if(n.action,a.needsAsyncEffect,'Restart'===n.action){const e=y.getActivePlayer();e&&(e.currentTime=0),'single'!==g.getPlaybackMode()&&toastr.info('已是第一首')}else a.needsAsyncEffect&&'number'==typeof a.targetIndex?await H(a.targetIndex):'DoNothing'===n.action&&toastr.info('next'===e?'已是歌单最后一首。':'已是歌单第一首。')}catch(e){await Y()}finally{await J(),await L()}}async function X(e){g.setPlaybackState('PLAYING'),Q(),await H(e)}function Z(){window.musicPlayerAPI={requestInitialization:()=>v?(Q(),Promise.resolve()):(b||(b=new Promise((e,t)=>{w={resolve:e,reject:t}})),b),togglePlayPause:()=>async function(){if(g.isPerformingEffect())return;const e=g.getTopQueueItem();if(e)try{g.setPerformingEffect(!0),Q();switch(g.getPlaybackState()){case'STOPPED':g.setPlaybackState('PLAYING'),Q(),await H(e.currentIndex);break;case'PLAYING':g.setPlaybackState('PAUSED'),Q(),await y.fadeOutAndPause();break;case'PAUSED':g.setPlaybackState('PLAYING'),Q(),await y.resumeAndFadeIn(g.getVolume())}}catch(e){await Y()}finally{await J(),await L()}else toastr.info('播放列表为空')}(),playNext:()=>{K('next')},playPrev:()=>{K('prev')},playIndex:e=>{const t=g.getTopQueueItem();t&&e>=0&&e<t.playlistContent.length&&async function(e){if(!g.isPerformingEffect())try{g.setPerformingEffect(!0),Q();const t=g.getTopQueueItem(),n=g.getPlaybackMode();if(t&&e===t.currentIndex){const e=y.getActivePlayer();e&&(e.currentTime=0)}else'list'===n||'single'===n?(g.setCurrentIndex(e),await H(e)):'random'===n&&(g.userInitiatedJump(e),await H(e))}catch(e){await Y()}finally{await J(),await L()}}(e)},persistVolumeAndBroadcast:e=>{const t=Math.max(0,Math.min(1,e)),n=y.getActivePlayer();g.setVolume(t),n&&!g.isPerformingEffect()&&(n.volume=t),L(),Q()},setLiveVolume:e=>{const t=y.getActivePlayer();t&&!g.isPerformingEffect()&&(t.volume=Math.max(0,Math.min(1,e)))},setPlaybackMode:e=>{const t=g.getPlaybackMode();e!==t&&(g.setPlaybackMode(e),h.setMode(e),h.getCurrentStrategy().constructor.name,'random'===t&&g.clearRandomModePlan(),'random'===e&&h.notifyQueueChanged(),L(),Q())},seekTo:e=>{const t=y.getActivePlayer();t?.duration&&(t.currentTime=t.duration*e)},getCurrentState:()=>{const e=g.getTopQueueItem(),t=e?.playlistContent??[],n=e?.currentIndex??0;return{currentItem:t[n]?{title:t[n].歌名,artist:t[n].歌手,cover:t[n].封面}:null,isPlaying:g.isPlaying(),playbackState:g.getPlaybackState(),playbackMode:g.getPlaybackMode(),masterVolume:g.getVolume(),playlist:t.map(e=>({title:e.歌名,artist:e.歌手,cover:e.封面})),isTransitioning:g.isPerformingEffect()}},onFullStateUpdate:e=>'function'==typeof e?(D.push(e),D.length,()=>{const t=D.indexOf(e);t>-1&&(D.splice(t,1),D.length)}):()=>{},onTimeUpdate:e=>'function'==typeof e?(F.push(e),()=>{const t=F.indexOf(e);t>-1&&F.splice(t,1)}):()=>{}},initializeGlobal('musicPlayerAPI',window.musicPlayerAPI)}async function ee(){if(v)return;const e=SillyTavern.getCurrentChatId?SillyTavern.getCurrentChatId():null;if(SillyTavern.chat.length>0&&null!==e){v=!0,M=e;try{const e=await N();if(!e)throw new Error('无法解析世界书配置，初始化中止。');const t=e.isMvu;if(t){if(!await async function(){try{await waitGlobalInitialized('Mvu')}catch(e){return!1}const e=1e4,t=250,n=Date.now();let a=!1;for(;Date.now()-n<e;){try{const e=await Mvu.getMvuData({type:'message',message_id:0});if(e&&(e.swipes_data||e.stat_data)){a=!0;break}}catch(e){}await new Promise(e=>setTimeout(e,t))}if(!a)return!1;try{return function(){const e=e=>e=>{k&&C&&R(e)};eventOn(Mvu.events.VARIABLE_UPDATE_ENDED,e('VARIABLE_UPDATE_ENDED'))}(),k=!0,!0}catch(e){return k=!1,!1}}())throw new Error('MVU集成初始化失败或超时，部分功能将不可用。')}else eventOn(tavern_events.MESSAGE_RECEIVED,e=>{S&&R(void 0)}),eventOn(tavern_events.MESSAGE_EDITED,async e=>{S&&(await R(void 0),await ne())});let n=null;t&&(n=await j()),await U(e,n),eventOn(tavern_events.CHARACTER_MESSAGE_RENDERED,e=>{S&&async function(e){if(0!==e&&g.getTopQueueItem())try{const t=getChatMessages(e)?.[0];t&&'user'!==t.role&&!t.message.includes('<DarkBramblePlayer/>')&&await setChatMessages([{message_id:e,message:`${t.message}\n<DarkBramblePlayer/>`}])}catch(e){}}(e)}),eventOn(tavern_events.MESSAGE_DELETED,e=>{S&&te('MESSAGE_DELETED')}),eventOn(tavern_events.MESSAGE_SWIPED,e=>{if(S&&function(e){const t=window.parent.SillyTavern?.getContext?.();if(!t||!t.chat)return!1;const n=t.chat[e];if(!n)return!1;const a=n.swipe_id,i=n.swipes;if(Array.isArray(i)&&'number'==typeof a){const e=i[a];return'string'==typeof e&&e.length>0}return!1}(e)&&C)if(0===e){const e=g.isPlaying();!async function(e){try{const t=await N(),n=await j();await U(t,n,e)}catch(e){}}({autoPlayIfWasPlaying:e})}else te('MESSAGE_SWIPED',{transitionEffect:'hard'})}),w&&w.resolve()}catch(e){if(w){const t=e instanceof Error?e.message:String(e);w.reject(t)}}finally{w=null}}}async function te(e,t){C&&(0!==x.length?(await R(void 0,t),await ne()):await ne())}async function ne(){if(g.getTopQueueItem())try{const e=getChatMessages(-1);if(!e||0===e.length)return;const t=e[0].message_id,n=`${Math.max(0,t-9)}-${t}`,a=getChatMessages(n);if(!a||0===a.length)return;let i=!1;for(let e=a.length-1;e>=0;e--){const t=a[e];if('user'===t.role)continue;if(0===t.message_id)break;if(t.message&&t.message.includes('<DarkBramblePlayer/>')){t.message_id,i=!0;break}t.message_id,t.role;const n=`${t.message}\n<DarkBramblePlayer/>`;await setChatMessages([{message_id:t.message_id,message:n}]),i=!0;break}}catch(e){}}$(()=>{y.initialize(),Z(),eventOn(tavern_events.CHAT_CHANGED,()=>{S=!1,y.getActivePlayer()?.pause(),reloadIframe()});const e=setInterval(()=>{ee(),v&&clearInterval(e)},250);setTimeout(()=>{v||(clearInterval(e),w&&(w.reject('Initialization timed out after 10 seconds.'),w=null))},1e4),$(window).on('pagehide',()=>{y.getActivePlayer()?.pause()})});export{o as ZodPersistedState,i as ZodPlaylistConfig,s as ZodQueueItemState,n as ZodSingleCondition,t as ZodTrackConfig,a as ZodTriggerConfig,r as ZodWorldbookConfig};
//# sourceMappingURL=index.js.map