const e=z;performance.now();const t=e.z.object({歌名:e.z.string().optional(),歌手:e.z.string().optional(),封面:e.z.string().url({message:'封面URL格式无效'}).optional(),url:e.z.string().url({message:'音轨URL格式无效'})}).strict(),n=e.z.object({variable_path:e.z.string(),greater_than:e.z.number().optional(),greater_than_or_equal_to:e.z.number().optional(),less_than:e.z.number().optional(),less_than_or_equal_to:e.z.number().optional(),value:e.z.union([e.z.string(),e.z.number(),e.z.boolean()]).optional(),value_contains:e.z.string().optional(),time_in_range:e.z.string().regex(/^\d{2}:\d{2}-\d{2}:\d{2}$/,{message:'时间范围格式必须是 "HH:MM-HH:MM"'}).optional()}).strict(),a=e.z.object({type:e.z.literal('mvu_variable'),playlist_id:e.z.string(),priority:e.z.number().default(0),conditions:e.z.array(n).nonempty({message:'触发器必须至少包含一个条件'})}).strict(),r=e.z.object({id:e.z.string(),onFinishRule:e.z.enum(['loop','pop'],{message:'onFinishRule 必须是 \'loop\' 或 \'pop\''}).default('loop'),tracks:e.z.array(t).nonempty({message:'歌单的 \'tracks\' 列表不能为空'})}),i=e.z.object({default_playlist_id:e.z.string().optional(),playlists:e.z.array(r).optional(),triggers:e.z.array(a).optional()}).strict(),s=e.z.object({playlistId:e.z.string(),currentIndex:e.z.number().default(0),playedIndices:e.z.array(e.z.number()).default([]),wasEverPlayed:e.z.boolean().default(!1),triggerSource:a.optional()}),o=e.z.object({active_queue:e.z.array(s),mode:e.z.enum(['list','single','random']).default('list'),volume:e.z.number().min(0).max(1).default(.5),last_active_swipe_id:e.z.number().nullable().default(null),finished_base_playlists:e.z.array(e.z.string()).default([]),previousMvuState:e.z.record(e.z.string(),e.z.any()).optional()}),l='灰烬双星_MVU状态记忆';function c(e){if(!e||'string'!=typeof e)return null;const t=e.trim().replace('：',':');let n;if(n=t.match(/^(\d{1,2})\s*:\s*(\d{1,2})$/),n){const e=parseInt(n[1],10),t=parseInt(n[2],10);if(e>=0&&e<24&&t>=0&&t<60)return 60*e+t}if(n=t.match(/^(\d{1,2})\s*时\s*(\d{1,2})\s*分?$/),n){const e=parseInt(n[1],10),t=parseInt(n[2],10);if(e>=0&&e<24&&t>=0&&t<60)return 60*e+t}return null}const u=(()=>{let e={};function t(e,t){if(!t)return!1;for(const n of e.conditions){const e=_.get(t,n.variable_path);let a=!1,r=!1;if(void 0!==n.value_contains)r=!0,'string'==typeof e&&e.includes(n.value_contains)&&(a=!0);else if(void 0!==n.time_in_range){if(r=!0,'string'==typeof e){const t=c(e);if(null!==t){const[e,r]=n.time_in_range.split('-'),i=c(e),s=c(r);null!==i&&null!==s&&(a=i<=s?t>=i&&t<=s:t>=i||t<=s)}}}else void 0!==n.value?(r=!0,e===n.value&&(a=!0)):void 0!==n.greater_than?(r=!0,'number'==typeof e&&e>n.greater_than&&(a=!0)):void 0!==n.greater_than_or_equal_to?(r=!0,'number'==typeof e&&e>=n.greater_than_or_equal_to&&(a=!0)):void 0!==n.less_than?(r=!0,'number'==typeof e&&e<n.less_than&&(a=!0)):void 0!==n.less_than_or_equal_to&&(r=!0,'number'==typeof e&&e<=n.less_than_or_equal_to&&(a=!0));if(!r||!a)return!1}return!0}return{checkTriggerCondition:t,initialize(){try{const t=getVariables({type:'chat'})[l];e=t&&'object'==typeof t?t:{}}catch(t){e={}}},resetState(){e={}},async persistCurrentState(t){if(b){e=_.cloneDeep(t);try{await updateVariablesWith(t=>(t[l]=e,t),{type:'chat'})}catch(e){}}},getPreviousState:()=>_.cloneDeep(e),calculateChangeReport(e,n,a){const r={newlyActiveTriggers:[],newlyInactiveTriggers:[]};for(const i of a){const a=t(i,e),s=t(i,n);!a&&s?(i.playlist_id,r.newlyActiveTriggers.push(i)):a&&!s&&(i.playlist_id,r.newlyInactiveTriggers.push(i))}return r.newlyActiveTriggers.length,r.newlyInactiveTriggers.length,r}}})(),d=(()=>{let e=[],t=null,n=new Set,a='list',r=.5,i='STOPPED',s=!1;function o(e,t){'number'!=typeof t||t<0||e.playedIndices.add(t)}return{getPlaybackMode:()=>a,getVolume:()=>r,isPlaying:()=>'PLAYING'===i,getPlaybackState:()=>i,isPerformingEffect:()=>s,getTopQueueItem:()=>_.cloneDeep(e[0]),getQueue:()=>_.cloneDeep(e),getStateSnapshotForRuntime:()=>_.cloneDeep({active_queue:e,mode:a,volume:r,isPlaying:'PLAYING'===i,playbackState:i,isPerformingEffect:s}),getStateSnapshotForPersistence:()=>({active_queue:_.cloneDeep(e).map(e=>({..._.omit(e,['playbackPlan','planIndex','playlistContent']),playedIndices:Array.from(e.playedIndices)})),mode:a,volume:r,last_active_swipe_id:t,finished_base_playlists:Array.from(n)}),resetState(){e=[],a='list',r=.5,i='STOPPED',s=!1,t=null,n.clear()},loadState(i){a=i.mode,r=i.volume,e=i.active_queue||[],t=i.last_active_swipe_id??null,n=new Set(i.finished_base_playlists||[]),n.size,e.length},setPlaybackMode:e=>{a=e},setVolume:e=>{r=e},setPlaybackState:e=>{i=e},setPerformingEffect:e=>{s=e},getLastActiveSwipeId:()=>t,setLastActiveSwipeId:e=>{t=e},getFinishedBasePlaylists:()=>new Set(n),addToFinishedBasePlaylists:e=>{n.add(e)},clearFinishedBasePlaylists:()=>{n.clear()},updateQueue(t){t.length,e=_.cloneDeep(t).sort((e,t)=>t.priority-e.priority),e.length>0&&(e[0].playlistId,e[0].priority)},setCurrentIndex(t){const n=e[0];n&&(o(n,n.currentIndex),n.currentIndex=t)},commitNavigationStep(t){const n=e[0];if(n){if(o(n,n.currentIndex),'random'===a&&n.playbackPlan){const e=n.playbackPlan.indexOf(t);-1!==e&&(n.planIndex=e)}n.currentIndex=t}},clearHistoryForCurrentItem(){const t=e[0];t&&t.playedIndices.clear()},resetCurrentItemForLoop(){const t=e[0];t&&(t.playedIndices.clear(),t.currentIndex=0)},commitGenesisState(t,n,a){const r=e[0];r&&(r.currentIndex=t,r.playbackPlan=n,r.planIndex=a)},userInitiatedJump(t){const n=e[0];if(n&&t!==n.currentIndex&&(o(n,n.currentIndex),n.currentIndex=t,'random'===this.getPlaybackMode()&&n.playbackPlan)){const e=n.playbackPlan.indexOf(t);-1!==e&&(n.planIndex=e)}},clearRandomModePlan(){const t=e[0];t&&(t.playbackPlan=void 0,t.planIndex=void 0)},applyNewPlaybackPlan(t,n){const a=e[0];a&&(a.playbackPlan=t,a.planIndex=n)}}})(),y=(()=>{let e=null,t=null,n=null,a=null,r=null;function i(e,t,n){return new Promise(a=>{if(r&&(clearInterval(r),r=null),!e)return a();const i=e.volume,s=n/50;if(s<=0)return e.volume=t,a();const o=(t-i)/s;let l=0;r=window.setInterval(()=>{l++,l>=s?(r&&clearInterval(r),r=null,e.volume=t,a()):e.volume+=o},50)})}return{initialize(){if(e&&t)return;const r=()=>{const e=new Audio;return e.preload='auto',e.crossOrigin='anonymous',e.addEventListener('ended',()=>{e===n&&async function(){if(d.isPerformingEffect())return;const e=d.getTopQueueItem();if(!e)return;try{d.setPerformingEffect(!0),F();const t=m.getCurrentStrategy().onTrackEnd(e),n=await H(t);n.needsAsyncEffect&&'number'==typeof n.targetIndex&&await q(n.targetIndex)}catch(e){await U()}finally{await Y(),await R('trackEnded')}}()}),e.addEventListener('error',()=>{}),e.addEventListener('timeupdate',Q),e};e=r(),t=r(),n=e,a=t},getActivePlayer:()=>n,getStandbyPlayer:()=>a,async transitionToTrack(e,t){if(e.slice(0,50),!a||!n)throw new Error('播放器实例尚未初始化');const r=a,s=n;r.src=e,r.load();try{await new Promise((e,t)=>{const n=()=>{r.removeEventListener('canplaythrough',n),r.removeEventListener('error',a),e()},a=e=>{r.removeEventListener('canplaythrough',n),r.removeEventListener('error',a);const i=e.target.error;t(new Error(`音频加载失败: ${i?.message||'未知错误'}`))};r.addEventListener('canplaythrough',n),r.addEventListener('error',a)})}catch(e){throw e}await i(s,0,500),s.pause(),[n,a]=[a,n];const o=this.getActivePlayer();if(!o)throw new Error('播放器实例在交换后丢失');const l=o.play();l&&await l,await i(o,t,500)},async fadeOutAndPause(){await i(n,0,400),n?.pause()},async executeHardCut(e,t){e.slice(0,50);const n=this.getActivePlayer();if(!n)throw new Error('No active player available for hard cut.');n.src.slice(-50),n.pause(),n.src=e,n.volume=t,n.src.slice(-50);try{const e=n.play();e&&await e,d.setPlaybackState('PLAYING')}catch(e){throw d.setPlaybackState('STOPPED'),e}},async resumeAndFadeIn(e){const t=n?.play();t&&await t,await i(n,e,400)}}})();class g{onQueueChanged(e){}advance(e,t){if(e.playlistId,e.currentIndex,e.onFinishRule,'next'===t)return this.onTrackEnd(e);const{currentIndex:n,onFinishRule:a,playlistContent:r}=e,i=r.length;if(n>0){const e=n-1;return{action:'GoTo',nextIndex:e}}if('loop'===a){const e=i>0?i-1:0;return{action:'GoTo',nextIndex:e}}return{action:'Restart'}}onTrackEnd(e){e.playlistId,e.currentIndex,e.onFinishRule;const{currentIndex:t,onFinishRule:n,playlistContent:a,playedIndices:r}=e,i=t+1;if(i<a.length)return{action:'GoTo',nextIndex:i};if('pop'===n)return{action:'RemoveTopAndAdvance'};{const e=a.length;return r.size+1>=e?{action:'LoopReset'}:{action:'GoTo',nextIndex:0}}}onPlaybackError(e){return this.advance(e,'next')}}class p{onQueueChanged(e){}advance(e,t){return{action:'Restart'}}onTrackEnd(e){return{action:'Restart'}}onPlaybackError(e){return{action:'Stop'}}}class f{_generateIntelligentShuffle(e,t,n){e.length,t.size;const a=e.filter(e=>!t.has(e)&&e!==n);a.length;for(let e=a.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[a[e],a[t]]=[a[t],a[e]]}return a.join(', '),a}_generatePlaybackPlan(e,t,n){e.size,n.length;const a=Array.from(new Set([...e,t])),r=a.indexOf(t),i=[...a,...n];return a.join(', '),i.join(', '),{playbackPlan:i,planIndex:r}}_handlePlanEnd(e){return e.playlistId,e.onFinishRule,'pop'===e.onFinishRule?{action:'RemoveTopAndAdvance'}:{action:'LoopReset'}}onQueueChanged(e){if(!e)return;e.playlistId;const t=e.playlistContent.map((_,e)=>e),n=this._generateIntelligentShuffle(t,e.playedIndices,e.currentIndex),{playbackPlan:a,planIndex:r}=this._generatePlaybackPlan(e.playedIndices,e.currentIndex,n);d.applyNewPlaybackPlan(a,r)}prepareGenesis(e){if(!e||!e.playlistContent)return null;const t=e.playlistContent.map((_,e)=>e);for(let e=t.length-1;e>0;e--){const n=Math.floor(Math.random()*(e+1));[t[e],t[n]]=[t[n],t[e]]}const n=t,a=n[0];return{newCurrentIndex:a,newPlaybackPlan:n,newPlanIndex:0}}advance(e,t){const{playbackPlan:n,planIndex:a}=e;if(!n||void 0===a)return{action:'DoNothing'};if(n.join(', '),'next'===t){const t=a+1;if(t<n.length){const e=n[t];return{action:'GoTo',nextIndex:e}}return this._handlePlanEnd(e)}{const e=a-1;if(e>=0){const t=n[e];return{action:'GoTo',nextIndex:t}}return{action:'DoNothing'}}}onTrackEnd(e){const{playbackPlan:t,planIndex:n}=e;if(!t||void 0===n)return{action:'Stop'};t.join(', ');const a=n+1;if(a<t.length){const e=t[a];return{action:'GoTo',nextIndex:e}}return this._handlePlanEnd(e)}onPlaybackError(e){return this.advance(e,'next')}}const m=(()=>{const e={list:new g,single:new p,random:new f};let t=e.list;return{setMode(n){t=e[n]},getCurrentStrategy:()=>t,notifyQueueChanged(){t.constructor.name;const e=d.getTopQueueItem();t.onQueueChanged(e)}}})(),I='余烬双星_播放器状态';let h=!1,P=!1,v=null,w=null,b=!0,S={},E=[],x='',T=!1,k=!1,C=null;const A=[],M=[];async function D(e,t){if(!P){P=!0;try{d.setPerformingEffect(!0),F();try{const n=d.getTopQueueItem(),a=e?.stat_data?e.stat_data:(await G())?.mvuData?.stat_data??{},r=u.getPreviousState(),i=u.calculateChangeReport(r,a,E),s=d.getQueue();if(i.newlyInactiveTriggers.length>0&&(_.remove(s,e=>i.newlyInactiveTriggers.some(t=>L(e.triggerSource,t))),i.newlyInactiveTriggers.length),i.newlyActiveTriggers.length>0)for(const e of i.newlyActiveTriggers){if(s.some(t=>t.triggerSource&&L(t.triggerSource,e))){e.playlist_id;continue}const t=N({type:'mvu',playlistId:e.playlist_id,trigger:e});t&&(s.push(t),t.playlistId)}d.updateQueue(s);const o=d.getTopQueueItem();if(o?.playlistId!==n?.playlistId)if(o){m.notifyQueueChanged(),o.wasEverPlayed=!0;const e=o.wasEverPlayed?o.currentIndex:0;if(d.isPlaying())'hard'===t?.transitionEffect?await y.executeHardCut(o.playlistContent[e].url,d.getVolume()):await q(e);else if(void 0===n&&'STOPPED'===d.getPlaybackState())await J(e);else{const t=o.playlistContent[e],n=y.getActivePlayer();t&&n&&(n.src=t.url)}}else await y.fadeOutAndPause(),d.setPlaybackState('STOPPED'),m.notifyQueueChanged();await u.persistCurrentState(a)}catch(e){}finally{await R('reconciliation')}}finally{P=!1,await Y()}}}function F(){const e=d.getTopQueueItem(),t=e?.playlistContent??[],n=e?.currentIndex??0,a={currentItem:t[n]?{title:t[n].歌名,artist:t[n].歌手,cover:t[n].封面}:null,isPlaying:d.isPlaying(),playbackState:d.getPlaybackState(),playbackMode:d.getPlaybackMode(),masterVolume:d.getVolume(),playlist:t.map(e=>({title:e.歌名,artist:e.歌手,cover:e.封面})),isTransitioning:d.isPerformingEffect()};A.forEach(e=>{try{e(a)}catch(e){}})}function Q(){const e=y.getActivePlayer();if(!d.isPlaying()||!e)return;const t={currentTime:e.currentTime,duration:e.duration||0};M.forEach(e=>e(t))}async function R(e){if(b)try{const e=d.getStateSnapshotForPersistence();await updateVariablesWith(t=>(t[I]=e,t),{type:'chat'})}catch(e){}}function O(e){const t=e.issues[0],n=t.path.join(' -> '),a=t.message,r=`路径: ${n} | 问题: ${a}`;toastr.error(r,'[MusicConfig] 内容错误',{timeOut:15e3})}function L(e,t){if(!e||!t)return e===t;if(e.playlist_id!==t.playlist_id)return!1;const n=e=>Object.keys(e).sort().map(t=>`${t}:${String(e[t])}`).join(','),a=e.conditions.map(n).sort(),r=t.conditions.map(n).sort();return a.length===r.length&&a.every((e,t)=>e===r[t])}async function G(e){if(e&&0===e.messageId&&'number'==typeof e.swipeId){e.messageId,e.swipeId;try{const t=await Mvu.getMvuData({type:'message',message_id:0}),n=t?.swipes_data?.[e.swipeId];if(n?.stat_data)return{mvuData:n,messageId:0};if(t?.stat_data)return{mvuData:t,messageId:0}}catch(e){}}try{const e=getChatMessages(-1,{include_swipes:!0});for(let t=e.length-1;t>=0;t--){const n=e[t].message_id;if('number'==typeof n)try{const e=await Mvu.getMvuData({type:'message',message_id:n});if(e?.stat_data)return{mvuData:e,messageId:n}}catch(e){}}return null}catch(e){return null}}async function B(){class e extends Error{constructor(e){super(e),this.name='ConfigMissingError'}}const t={playlists:[],triggers:[],defaultPlaylistId:void 0,_defaultPlaylistIdSourceFile:null};try{const n=getCharWorldbookNames('current'),a=[n.primary,...n.additional].filter(Boolean);if(0===a.length)throw new e('角色卡未关联任何世界书。');let r=!1;for(const e of a){if(!e)continue;const n=(await getWorldbook(e)).filter(e=>e.name.includes('[MusicConfig]'));n.length>0&&(r=!0);for(const e of n){e.name;try{const n=YAML.parse(e.content),a=i.safeParse(n);if(!a.success){e.name,O(a.error);continue}const r=a.data;if(r.playlists&&t.playlists.push(...r.playlists.map(t=>({...t,_sourceFile:e.name}))),r.triggers&&t.triggers.push(...r.triggers.map(t=>({...t,_sourceFile:e.name}))),r.default_playlist_id){if(t.defaultPlaylistId&&t.defaultPlaylistId!==r.default_playlist_id){const n=`在文件 "${e.name}" 中发现的 default_playlist_id ("${r.default_playlist_id}") 覆盖了来自文件 "${t._defaultPlaylistIdSourceFile??'未知'}" 的定义 ("${t.defaultPlaylistId}")。为确保行为可预测，建议只保留一个定义。`;toastr.warning(n,'配置警告',{timeOut:2e4,closeButton:!0})}t.defaultPlaylistId=r.default_playlist_id,t._defaultPlaylistIdSourceFile=e.name}}catch(t){e.name,t.message,toastr.error(`[MusicConfig] 文件 "${e.name}" 格式错误：YAML 语法不正确。`,'配置错误',{timeOut:1e4})}}}if(!r)throw new e('在已关联的世界书中，未找到任何包含 [MusicConfig] 的条目。');let s=!0;const o=_.groupBy(t.playlists,'id');for(const e in o)if(o[e].length>1){const t=`[MusicConfig] 致命错误: 歌单 ID "${e}" 在多个文件中重复定义。来源: ${o[e].map(e=>e._sourceFile).join(', ')}。ID 必须是唯一的。`;toastr.error(t,'配置冲突',{timeOut:15e3}),s=!1}const l=new Set(t.playlists.map(e=>e.id));if(t.defaultPlaylistId&&!l.has(t.defaultPlaylistId)){const e=`[MusicConfig] 配置错误: 最终的 default_playlist_id ("${t.defaultPlaylistId}", 来自文件 "${t._defaultPlaylistIdSourceFile??'未知'}") 指向了一个不存在的歌单。`;toastr.error(e,'配置错误',{timeOut:15e3}),t.defaultPlaylistId=void 0}const c=t.triggers.filter(e=>{if(l.has(e.playlist_id))return!0;const t=`[MusicConfig] 校验失败: 来自文件 "${e._sourceFile}" 的触发器指向了不存在的歌单ID "${e.playlist_id}"。该触发器将被忽略。`;return toastr.error(t,'配置错误',{timeOut:1e4}),!1});if(!s)return null;if(0===t.playlists.length)throw new e('所有配置文件中都未能找到任何有效的歌单 (playlists)。');const u={};for(const e of t.playlists){const t=e.tracks.map(e=>({url:e.url,歌名:e.歌名&&''!==e.歌名.trim()?e.歌名:decodeURIComponent(e.url.split('/').pop()?.split('?')[0]||'未知歌曲'),歌手:e.歌手,封面:e.封面}));u[e.id]={..._.omit(e,'_sourceFile'),tracks:t}}return{playlists:u,defaultId:t.defaultPlaylistId,triggers:c.map(e=>_.omit(e,'_sourceFile'))}}catch(t){return t instanceof e?(t.message,toastr.error(t.message,'[音乐播放器] 配置缺失',{timeOut:2e4,closeButton:!0})):toastr.error('播放器在加载设置时遇到一个临时问题。这通常可以通过按 F5 刷新酒馆页面来解决。','[音乐播放器] 加载时遇到临时问题',{timeOut:2e4,closeButton:!0}),null}}function j(e,t){return{playlistId:e.playlistId,priority:e.triggerSource?.priority??-1/0,playlistContent:_.cloneDeep(t.tracks),onFinishRule:t.onFinishRule,currentIndex:e.currentIndex,playedIndices:new Set(e.playedIndices),wasEverPlayed:e.wasEverPlayed,triggeredBy:e.triggerSource?'mvu':'base',triggerSource:e.triggerSource}}function N(e){const{playlistId:t}=e;if(!t||!S[t])return null;const n=S[t],a={playlistId:t,playlistContent:_.cloneDeep(n.tracks),currentIndex:0,playedIndices:new Set,wasEverPlayed:!1};return'base'===e.type?{...a,priority:-1/0,triggeredBy:'base',onFinishRule:n.onFinishRule??'loop'}:{...a,priority:e.trigger.priority,triggeredBy:'mvu',onFinishRule:n.onFinishRule,triggerSource:e.trigger}}async function V(e,t,n){try{k=!0;const a=function(){const e=getVariables({type:'chat'})[I];if(!e||'object'!=typeof e)return null;const t=o.safeParse(e);return t.success?t.data:null}();d.resetState(),a&&d.loadState(a),u.resetState(),u.initialize();const r=y.getActivePlayer();if(r&&r.pause(),E=[],S={},x='',!e)throw F(),new Error('世界书音乐配置解析失败，请检查配置。');S=e.playlists,x=e.defaultId,E=e.triggers;const i=t?.mvuData?.stat_data??null,s=t?.messageId;let l=[],c=x;const g=getChatMessages(0,{include_swipes:!0})[0],p=g?.swipe_id??0;if(g){const e=g.swipes?.[g.swipe_id],t=e?.match(/<playlist:([^>]+)>/);if(t&&t[1]){const e=t[1];if(S[e])c=e;else{const t=`[MusicConfig] 配置警告: 开场白标签 <playlist:${e}> 指向了一个不存在的歌单ID。将回退至默认歌单。`;toastr.warning(t,'配置警告',{timeOut:15e3})}}}const f=d.getLastActiveSwipeId();if(null!==f&&f!==p&&d.clearFinishedBasePlaylists(),d.setLastActiveSwipeId(p),c){if(new Set(E.map(e=>e.playlist_id)).has(c)){const e=`[MusicConfig] 致命配置错误: 歌单 "${c}" 不能同时被用作基础歌单（在开场白或默认设置中）和场景歌单（被触发器关联）。请为它们使用不同的歌单。`;throw toastr.error(e,'配置冲突',{timeOut:2e4,closeButton:!0}),new Error('基础歌单与场景歌单存在致命冲突。')}}if(a){const e=[];for(const t of a.active_queue){if(!Object.prototype.hasOwnProperty.call(S,t.playlistId)){t.playlistId;continue}const n=S[t.playlistId];if(!t.triggerSource)t.playlistId===c?(t.playlistId,e.push(j(t,n))):t.playlistId;else{const a=E.find(e=>e.playlist_id===t.playlistId);if(t.playlistId,'pop'===n.onFinishRule)continue;if(!a)continue;if(!u.checkTriggerCondition(a,i))continue;e.push(j(t,n))}}l=e}if(i&&E.length>0)for(const e of E){if(!l.some(t=>t.triggerSource&&L(t.triggerSource,e))&&u.checkTriggerCondition(e,i)){const t=S[e.playlist_id];if(t&&'pop'===t.onFinishRule)if(0===s){e.playlist_id;const t=N({type:'mvu',playlistId:e.playlist_id,trigger:e});t&&l.push(t)}else e.playlist_id;else{const t=N({type:'mvu',playlistId:e.playlist_id,trigger:e});t&&l.push(t)}}}if(!l.some(e=>'base'===e.triggeredBy)&&c&&S[c]){if(d.getFinishedBasePlaylists().has(c));else{const e=N({type:'base',playlistId:c});e&&l.push(e)}}d.updateQueue(l);const h=d.getPlaybackMode();m.setMode(h),m.notifyQueueChanged(),y.initialize();const P=d.getVolume();y.getActivePlayer()&&(y.getActivePlayer().volume=P),y.getStandbyPlayer()&&(y.getStandbyPlayer().volume=0);const v=d.getTopQueueItem();if(v){const e=v.playlistContent[v.currentIndex];e&&y.getActivePlayer()&&(y.getActivePlayer().src=e.url)}if(i?await u.persistCurrentState(i):await u.persistCurrentState({}),await R(),F(),n?.autoPlayIfWasPlaying){d.getTopQueueItem()&&await async function(){if(d.isPerformingEffect())return;const e=d.getTopQueueItem();if(!e)return;try{d.setPerformingEffect(!0),e.currentIndex,await J(e.currentIndex)}catch(e){d.setPlaybackState('STOPPED'),F()}finally{await Y(),await R()}}()}}catch(e){throw e}}async function q(e){const t=d.getTopQueueItem();if(!t)return Promise.resolve();const n=t.playlistContent[e];if(!n?.url)throw new Error(`Invalid track at index ${e}`);try{await y.transitionToTrack(n.url,d.getVolume()),d.setPlaybackState('PLAYING'),function(){const e=d.getTopQueueItem(),t=y.getStandbyPlayer();if(!t||!e)return;const n=e.currentIndex+1;if(n<e.playlistContent.length){const a=e.playlistContent[n];a&&t.src!==a.url&&(t.src=a.url,t.load())}}()}catch(e){throw e}}async function U(){let e=1;const t=d.getTopQueueItem(),n=t?.playlistContent.length??0;for(t&&toastr.error(`歌曲《${t.playlistContent[t.currentIndex]?.歌名??'未知歌曲'}》加载失败，正在尝试自动处理...`);;){if(n>0&&e>=n)return t&&toastr.error(`歌单《${t.playlistId}》中所有歌曲均无法加载，播放已停止。`),d.setPlaybackState('STOPPED'),void F();const a=d.getTopQueueItem();if(!a)return d.setPlaybackState('STOPPED'),void F();const r=m.getCurrentStrategy().onPlaybackError(a);m.getCurrentStrategy().constructor.name,r.action;const i=await H(r);if(!i.needsAsyncEffect)return;if('number'!=typeof i.targetIndex)return d.setPlaybackState('STOPPED'),void F();try{return await q(i.targetIndex),void F()}catch(t){e++;const n=d.getTopQueueItem(),a=n?.playlistContent[n.currentIndex]?.歌名??'未知歌曲';toastr.error(`下一首《${a}》加载失败...`)}}}async function H(e){e.action,e.nextIndex;let t,n=!1;const a=d.getTopQueueItem();switch(e.action){case'GoTo':'number'==typeof e.nextIndex?(d.commitNavigationStep(e.nextIndex),n=!0,t=e.nextIndex):n=!1;break;case'Restart':a&&(n=!0,t=a.currentIndex);break;case'RemoveTopAndAdvance':{const e=d.getTopQueueItem();e&&'base'===e.triggeredBy&&'pop'===e.onFinishRule&&(e.playlistId,d.addToFinishedBasePlaylists(e.playlistId));const a=d.getQueue();a.shift();d.updateQueue(a),m.notifyQueueChanged();const r=d.getTopQueueItem();r?(r.playlistId,r.currentIndex,n=!0,t=r.currentIndex):(await y.fadeOutAndPause(),d.setPlaybackState('STOPPED'),n=!1);break}case'LoopReset':{d.resetCurrentItemForLoop();if('random'===d.getPlaybackMode()){const e=m.getCurrentStrategy().prepareGenesis(d.getTopQueueItem());e&&d.commitGenesisState(e.newCurrentIndex,e.newPlaybackPlan,e.newPlanIndex)}const e=d.getTopQueueItem()?.currentIndex??0;n=!0,t=e;break}case'Stop':d.setPlaybackState('STOPPED')}'RemoveTopAndAdvance'!==e.action&&F();const r={needsAsyncEffect:n,targetIndex:t};return r}async function Y(){d.setPerformingEffect(!1),F()}async function W(e){if(d.isPerformingEffect())return;const t=d.getTopQueueItem();if(t)try{d.setPerformingEffect(!0),F();const n=m.getCurrentStrategy().advance(t,e),a=await H(n);if(n.action,a.needsAsyncEffect,'Restart'===n.action){const e=y.getActivePlayer();e&&(e.currentTime=0),'single'!==d.getPlaybackMode()&&toastr.info('已是第一首')}else a.needsAsyncEffect&&'number'==typeof a.targetIndex?await q(a.targetIndex):'DoNothing'===n.action&&toastr.info('next'===e?'已是歌单最后一首。':'已是歌单第一首。')}catch(e){await U()}finally{await Y(),await R()}}async function J(e){d.setPlaybackState('PLAYING'),F(),await q(e)}function K(){window.musicPlayerAPI={requestInitialization:()=>h?(F(),Promise.resolve()):(w||(w=new Promise((e,t)=>{v={resolve:e,reject:t}})),w),togglePlayPause:()=>async function(){if(d.isPerformingEffect())return;const e=d.getTopQueueItem();if(e)try{d.setPerformingEffect(!0),F();switch(d.getPlaybackState()){case'STOPPED':d.setPlaybackState('PLAYING'),F(),await q(e.currentIndex);break;case'PLAYING':d.setPlaybackState('PAUSED'),F(),await y.fadeOutAndPause();break;case'PAUSED':d.setPlaybackState('PLAYING'),F(),await y.resumeAndFadeIn(d.getVolume())}}catch(e){await U()}finally{await Y(),await R()}else toastr.info('播放列表为空')}(),playNext:()=>{W('next')},playPrev:()=>{W('prev')},playIndex:e=>{const t=d.getTopQueueItem();t&&e>=0&&e<t.playlistContent.length&&async function(e){if(!d.isPerformingEffect())try{d.setPerformingEffect(!0),F();const t=d.getTopQueueItem(),n=d.getPlaybackMode();if(t&&e===t.currentIndex){const e=y.getActivePlayer();e&&(e.currentTime=0)}else'list'===n||'single'===n?(d.setCurrentIndex(e),await q(e)):'random'===n&&(d.userInitiatedJump(e),await q(e))}catch(e){await U()}finally{await Y(),await R()}}(e)},persistVolumeAndBroadcast:e=>{const t=Math.max(0,Math.min(1,e)),n=y.getActivePlayer();d.setVolume(t),n&&!d.isPerformingEffect()&&(n.volume=t),R(),F()},setLiveVolume:e=>{const t=y.getActivePlayer();t&&!d.isPerformingEffect()&&(t.volume=Math.max(0,Math.min(1,e)))},setPlaybackMode:e=>{const t=d.getPlaybackMode();e!==t&&(d.setPlaybackMode(e),m.setMode(e),m.getCurrentStrategy().constructor.name,'random'===t&&d.clearRandomModePlan(),'random'===e&&m.notifyQueueChanged(),R(),F())},seekTo:e=>{const t=y.getActivePlayer();t?.duration&&(t.currentTime=t.duration*e)},getCurrentState:()=>{const e=d.getTopQueueItem(),t=e?.playlistContent??[],n=e?.currentIndex??0;return{currentItem:t[n]?{title:t[n].歌名,artist:t[n].歌手,cover:t[n].封面}:null,isPlaying:d.isPlaying(),playbackState:d.getPlaybackState(),playbackMode:d.getPlaybackMode(),masterVolume:d.getVolume(),playlist:t.map(e=>({title:e.歌名,artist:e.歌手,cover:e.封面})),isTransitioning:d.isPerformingEffect()}},onFullStateUpdate:e=>'function'==typeof e?(A.push(e),A.length,()=>{const t=A.indexOf(e);t>-1&&(A.splice(t,1),A.length)}):()=>{},onTimeUpdate:e=>'function'==typeof e?(M.push(e),()=>{const t=M.indexOf(e);t>-1&&M.splice(t,1)}):()=>{}},initializeGlobal('musicPlayerAPI',window.musicPlayerAPI)}async function X(){if(h)return;const e=SillyTavern.getCurrentChatId?SillyTavern.getCurrentChatId():null;if(SillyTavern.chat.length>0&&null!==e){h=!0,C=e;try{const e=await B();if(!e)throw new Error('无法解析世界书配置，初始化中止。');const t=e.triggers&&Array.isArray(e.triggers)&&e.triggers.length>0;if(t){if(!await async function(){try{await waitGlobalInitialized('Mvu')}catch(e){return!1}const e=1e4,t=250,n=Date.now();let a=!1;for(;Date.now()-n<e;){try{const e=await Mvu.getMvuData({type:'message',message_id:0});if(e&&(e.swipes_data||e.stat_data)){a=!0;break}}catch(e){}await new Promise(e=>setTimeout(e,t))}if(!a)return!1;try{return function(){const e=e=>e=>{T&&k&&D(e)};eventOn(Mvu.events.VARIABLE_UPDATE_ENDED,e('VARIABLE_UPDATE_ENDED')),eventOn(tavern_events.MESSAGE_DELETED,e('MESSAGE_DELETED'))}(),T=!0,!0}catch(e){return T=!1,!1}}())throw new Error('MVU集成初始化失败或超时，部分功能将不可用。')}let n=null;t&&(n=await G()),await V(e,n),eventOn(tavern_events.CHARACTER_MESSAGE_RENDERED,e=>{!async function(e){if(0!==e&&d.getTopQueueItem())try{const t=getChatMessages(e)?.[0];t&&'user'!==t.role&&!t.message.includes('<DarkBramblePlayer/>')&&await setChatMessages([{message_id:e,message:`${t.message}\n<DarkBramblePlayer/>`}])}catch(e){}}(e)}),eventOn(tavern_events.MESSAGE_SWIPED,e=>{if(k)if(0===e){const e=d.isPlaying();!async function(e){try{const t=await B(),n=await G();await V(t,n,e)}catch(e){}}({autoPlayIfWasPlaying:e})}else!async function(e,t){if(!k)return;if(0===E.length)return void await Z();const n=await G();n?.mvuData&&(await D(n?.mvuData,t),await Z())}(0,{transitionEffect:'hard'})}),v&&v.resolve()}catch(e){if(v){const t=e instanceof Error?e.message:String(e);v.reject(t)}}finally{v=null}}}async function Z(){if(d.getTopQueueItem())try{const e=getChatMessages(-1);if(!e||0===e.length)return;const t=e[0];if(0===t.message_id)return;if('user'===t.role)return;if(t.message&&t.message.includes('<DarkBramblePlayer/>'))return;const n=t.message_id;t.role;const a=`${t.message}\n<DarkBramblePlayer/>`;await setChatMessages([{message_id:n,message:a}])}catch(e){}}$(()=>{y.initialize(),K(),eventOn(tavern_events.CHAT_CHANGED,()=>{b=!1,y.getActivePlayer()?.pause(),reloadIframe()});const e=setInterval(()=>{X(),h&&clearInterval(e)},250);setTimeout(()=>{h||(clearInterval(e),v&&(v.reject('Initialization timed out after 10 seconds.'),v=null))},1e4),$(window).on('pagehide',()=>{y.getActivePlayer()?.pause()})});export{o as ZodPersistedState,r as ZodPlaylistConfig,s as ZodQueueItemState,n as ZodSingleCondition,t as ZodTrackConfig,a as ZodTriggerConfig,i as ZodWorldbookConfig};
//# sourceMappingURL=index.js.map